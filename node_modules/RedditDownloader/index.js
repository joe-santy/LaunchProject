const fse = require('fs-extra');
const inquirer = require('inquirer');
const fetch = require('fetch');
const cp = require('child_process');
const path = require('path');

(function prompt(){
  inquirer.prompt([{type: String, name: "subreddit", message: "What would you like to download pictures of?"}]).then(function(answer){
    fetch.fetchUrl("http://reddit.com/r/"+answer.subreddit+".json", function(err, meta, body){
      if (err){
        console.error(err);
      } else {
        let responseObjects = JSON.parse(body).data.children;
        function findUrls(children){
            let urls = [];
            for (let i=0; i<children.length; i++){
                if (children[i].data.url){
                    urls.push(children[i].data.url);
                }
            }
            return urls;
        }
        let urls = findUrls(responseObjects);

        for (let i=0; i < urls.length; i++){
          if (urls[i].match(/\.jpg/)){
            let out = fse.createWriteStream(path.join(__dirname, "images/") + answer.subreddit + i.toString() + '.jpg');
            new fetch.FetchStream(urls[i]).pipe(out);
          }
        }
        prompt();
      }
    });
  });
})();
